import sqlite3
from pathlib import Path

from .tables import ({%
    for i, table in enumerate(database.tables)
        %}
    {{ table.dataclass }}sTable{%
            if i < len(database.tables) - 1
                %},{%
            endif
        %}{%
    endfor
%}
)


class Database:
    def __init__(self):
        self.connections = 0
        self.con = None
        self.cur = None
        self.tables = []
        self.path = Path(
            Path(__file__).resolve().parent,
            'data.db'
        ).resolve()
        {%
    for table in database.tables
        %}
        self.{{ table.name }} = {{ table.dataclass }}sTable(self)
        self.tables.append(self.{{ table.name }}){%
    endfor
%}


    def init_tables(self):
        with self:
            for table in self.tables:
                table.init_db()
    

    def __enter__(self):
        if not self.con:
            self.con = sqlite3.connect(self.path)
            self.cur = self.con.cursor()
        self.connections += 1


    def __exit__(self, *args, **kwargs):
        self.connections -= 1
        if not self.connections:
            self.con.commit()
            self.con.close()
            self.con = None
            self.cur = None

